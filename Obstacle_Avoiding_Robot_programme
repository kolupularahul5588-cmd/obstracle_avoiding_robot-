#include <AFMotor.h>
#include <Servo.h>

// Motor setup
AF_DCMotor motor1(1, MOTOR12_1KHZ);
AF_DCMotor motor2(2, MOTOR12_1KHZ);
AF_DCMotor motor3(3, MOTOR12_1KHZ);
AF_DCMotor motor4(4, MOTOR12_1KHZ);
// Ultrasonic pins
#define trigPin A0
#define echoPin A1

Servo myServo;

long duration;
int distance;

void setup() {
  Serial.begin(9600);
  Serial.println("Obstacle Avoiding Robot Started...");
  
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);

  myServo.attach(10);
  myServo.write(90);  
  Serial.println("Servo Centered at 90°");
  
  delay(1000);
}

void loop() {

  Serial.println("---------------------------");
  Serial.println("Checking Distance...");
  
  distance = getDistance();

  Serial.print("Distance: ");
  Serial.print(distance);
  Serial.println(" cm");

  if (distance > 20) {
    Serial.println("Path Clear -> Moving Forward");
    moveForward();
  } 
  else {
    Serial.println("Obstacle Detected!");
    
    stopMotors();
    Serial.println("Motors Stopped");
    delay(500);

    Serial.println("Moving Backward");
    moveBackward();
    delay(500);
    
    stopMotors();
    Serial.println("Stopped Again");
    delay(500);

    Serial.println("Scanning Right...");
    int rightDistance = lookRight();
    Serial.print("Right Distance: ");
    Serial.print(rightDistance);
    Serial.println(" cm");
    delay(500);

    Serial.println("Scanning Left...");
    int leftDistance = lookLeft();
    Serial.print("Left Distance: ");
    Serial.print(leftDistance);
    Serial.println(" cm");
    delay(500);

    if (rightDistance >= leftDistance) {
      Serial.println("Turning Right");
      turnRight();
      delay(600);
    } 
    else {
      Serial.println("Turning Left");
      turnLeft();
      delay(600);
    }

    stopMotors();
    Serial.println("Turn Complete -> Motors Stopped");
  }

  delay(300);
}

// ================= Ultrasonic Function =================
int getDistance() {

  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);

  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  duration = pulseIn(echoPin, HIGH);

  distance = duration * 0.034 / 2;

  if (distance == 0) {
    Serial.println("Warning: No Echo Received!");
    distance = 400; // Max range fallback
  }

  return distance;
}

// ================= Movement Functions =================
void moveForward() {
  motor1.setSpeed(150);
  motor2.setSpeed(150);
  motor3.setSpeed(150);
  motor4.setSpeed(150);
  motor1.run(FORWARD);
  motor2.run(FORWARD);
  motor3.run(FORWARD);
  motor4.run(FORWARD);
  Serial.println("Motors Running FORWARD");
}

void moveBackward() {
  motor1.setSpeed(150);
  motor2.setSpeed(150);
  motor3.setSpeed(150);
  motor4.setSpeed(150);
  motor1.run(BACKWARD);
  motor2.run(BACKWARD);
  motor3.run(BACKWARD);
  motor4.run(BACKWARD);
  Serial.println("Motors Running BACKWARD");
}

void turnRight() {
  motor1.setSpeed(150);
  motor2.setSpeed(150);
  motor3.setSpeed(150);
  motor4.setSpeed(150);

  motor1.run(FORWARD);
  motor2.run(FORWARD);
  motor3.run(BACKWARD);
  motor4.run(BACKWARD);

  Serial.println("Motors Turning RIGHT");
}

void turnLeft() {
  motor1.setSpeed(150);
  motor2.setSpeed(150);

  motor3.run(FORWARD);
  motor4.run(FORWARD);
  motor1.run(BACKWARD);
  motor2.run(BACKWARD);


  Serial.println("Motors Turning LEFT");
}

void stopMotors() {
  motor1.run(RELEASE);
  motor2.run(RELEASE);
  motor3.run(RELEASE);
  motor4.run(RELEASE);

  Serial.println("Motors Released");
}

// ================= Servo Scan Functions =================
int lookRight() {
  Serial.println("Servo Turning to 30° (Right)");
  myServo.write(30);
  delay(500);

  int distance = getDistance();

  Serial.println("Returning Servo to Center (90°)");
  myServo.write(90);
  return distance;
}

int lookLeft() {
  Serial.println("Servo Turning to 150° (Left)");
  myServo.write(150);
  delay(500);

  int distance = getDistance();

  Serial.println("Returning Servo to Center (90°)");
  myServo.write(90);
  return distance;
}
